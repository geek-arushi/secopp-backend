<!DOCTYPE html>
<html lang="en">

<head>
    <%- include("./partials/header.ejs") %>
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/quill-image-uploader@1.2.3/dist/quill.imageUploader.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <!-- ======= Header ======= -->
    <%- include("./partials/nav-header.ejs") %>
        <!-- End Header -->

        <!-- ======= Sidebar ======= -->
        <%- include("./partials/admin-sidebar.ejs") %>
            <!-- End Sidebar-->

            <main id="main" class="main">
                <%- include("./partials/flashMessage.ejs") %>
                    <div class="pagetitle">
                        <h1>Edit Blog</h1>
                        <nav>
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="">Home</a></li>
                                <li class="breadcrumb-item "><a href="/admin/blogs">All Blogs</a></li>
                                <li class="breadcrumb-item active">
                                    <%= blog.blogCardTitle %>
                                </li>
                            </ol>
                        </nav>
                    </div><!-- End Page Title -->

                    <section class="section">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body">
                                        <!-- Blog Form -->

                                        <form action="/admin/edit-blog/<%= blog._id %>" method="POST"
                                            enctype="multipart/form-data" id="editForm"
                                            class="row g-3 needs-validation">
                                            <h2 class="text-primary">Edit Data for blog Card*</h2>

                                            <div class="col-md-4">
                                                <label for="blogCardTitle" class="form-label fw-semibold">Blog Card
                                                    Title :</label>
                                                <input type="text" class="form-control" id="blogCardTitle"
                                                    name="blogCardTitle" value="<%= blog.blogCardTitle %>" required />
                                            </div>

                                            <div class="col-md-4">
                                                <label for="blogCardDescription" class="form-label fw-semibold">Blog
                                                    Card
                                                    Description :</label>
                                                <input type="text" class="form-control" id="blogCardDescription"
                                                    name="blogCardDescription" value="<%= blog.blogCardDescription %>"
                                                    required />
                                            </div>

                                            <div class="col-md-4">
                                                <label for="blogCategory" class="form-label fw-semibold">Blog Category
                                                    :</label>
                                                <select id="blogCategory" class="form-select" name="blogCategory"
                                                    required>
                                                    <option>Select Blog Category</option>
                                                    <option value="Cancer" <%=blog.blogCategory==='Cancer' ? 'selected'
                                                        : "" %> >Cancer</option>
                                                    <option value="Orthopedic" <%=blog.blogCategory==='Orthopedic'
                                                        ? 'selected' : "" %> >Orthopedics</option>
                                                </select>
                                            </div>

                                            <div class="col-md-8">
                                                <label for="blogCardImage" class="form-label fw-semibold">Blog Card
                                                    Image
                                                    :</label>
                                                <input class="form-control" type="file" name="blogCardImage"
                                                    id="blogCardImage">
                                            </div>

                                            <div class="col-md-4">
                                                <label for="likes" class="form-label fw-semibold">No of Likes
                                                    :</label>
                                                <input class="form-control" type="number" name="likes" id="likes"
                                                    required value="<%= blog.likes %>">
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label text-primary h2">Edit your blog</label>
                                                <div id="editor" style="height: 500px;"></div>
                                                <input type="hidden" name="content" id="hiddenContent" />
                                            </div>

                                            <button type="submit" class="btn btn-success">Update Blog</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

            </main>
            <!-- End #main -->

            <!-- ======= Footer ======= -->
            <%- include('./partials/footer.ejs') %>

                <script>
                    Quill.register("modules/imageUploader", window.ImageUploader);

                    const quill = new Quill("#editor", {
                        theme: "snow",
                        modules: {
                            toolbar: [
                                [{ header: [1, 2, 3, 4, 5, 6, false] }],
                                ["bold", "italic", "underline"],
                                ["link", "image"],
                                [{ list: "ordered" }, { list: "bullet" }],
                                ["clean"]
                            ],
                            imageUploader: {
                                upload: file => {
                                    return new Promise((resolve, reject) => {
                                        const formData = new FormData();
                                        formData.append("file", file);
                                        formData.append("upload_preset", "Preset_1"); // ðŸ” Replace
                                        fetch("https://api.cloudinary.com/v1_1/dwxpjipx6/image/upload", {
                                            method: "POST",
                                            body: formData
                                        })
                                            .then(res => res.json())
                                            .then(res => {
                                                resolve(res.secure_url);
                                            })
                                            .catch(() => {
                                                reject("Image upload failed");
                                            });
                                    });
                                }
                            }
                        }
                    });

                    // Load existing HTML content into Quill
                    const existingContent = `<%- blog.content %>`;
                    quill.root.innerHTML = existingContent;

                    // When form is submitted, extract HTML
                    document.getElementById("editForm").addEventListener("submit", function () {
                        document.getElementById("hiddenContent").value = quill.root.innerHTML;
                    });
                </script>
</body>

</html>